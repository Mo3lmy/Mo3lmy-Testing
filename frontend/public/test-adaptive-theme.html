<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Adaptive Theme System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
        }
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        .control-group {
            flex: 1;
            min-width: 200px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }
        input, select, button {
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #ddd;
            font-size: 16px;
            width: 100%;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .slide-preview {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: white;
            overflow: hidden;
        }
        .slide-preview iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .status.success {
            background: #d4f8e8;
            color: #00875a;
        }
        .status.error {
            background: #ffe5e5;
            color: #de350b;
        }
        .logs {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 3px 0;
        }
        .log-entry.error {
            color: red;
        }
        .log-entry.success {
            color: green;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„ØªÙƒÙŠÙÙŠ</h1>

        <div id="status-container"></div>

        <div class="controls">
            <div class="control-group">
                <label for="subject">Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
                <input type="text" id="subject" value="Ø§Ù„Ø¹Ù„ÙˆÙ…" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª">
            </div>

            <div class="control-group">
                <label for="topic">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</label>
                <input type="text" id="topic" value="Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù…Ø³ÙŠ" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ÙƒØ³ÙˆØ±">
            </div>

            <div class="control-group">
                <label for="grade">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</label>
                <select id="grade">
                    <option value="1">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option>
                    <option value="2">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                    <option value="3">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                    <option value="4">Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
                    <option value="5">Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option>
                    <option value="6" selected>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
                    <option value="7">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¨Ø¹</option>
                    <option value="8">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù…Ù†</option>
                    <option value="9">Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹</option>
                    <option value="10">Ø§Ù„ØµÙ Ø§Ù„Ø¹Ø§Ø´Ø±</option>
                    <option value="11">Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±</option>
                    <option value="12">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±</option>
                </select>
            </div>

            <div class="control-group">
                <label>&nbsp;</label>
                <button onclick="generateSlides()">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­</button>
            </div>
        </div>

        <div class="slide-preview">
            <iframe id="slideFrame" srcdoc="<div style='display: flex; align-items: center; justify-content: center; height: 100vh; font-family: Arial; color: #999;'>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ 'ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­' Ù„Ù„Ø¨Ø¯Ø¡</div>"></iframe>
        </div>

        <div class="logs" id="logs">
            <div class="log-entry">Ø¬Ø§Ù‡Ø² Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        const logsContainer = document.getElementById('logs');
        const statusContainer = document.getElementById('status-container');
        const slideFrame = document.getElementById('slideFrame');

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsContainer.appendChild(entry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function showStatus(message, type = 'info') {
            statusContainer.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function generateSlides() {
            const subject = document.getElementById('subject').value;
            const topic = document.getElementById('topic').value;
            const grade = parseInt(document.getElementById('grade').value);

            log('Starting slide generation...', 'info');
            showStatus('Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­...', 'info');

            try {
                const response = await fetch(`${API_BASE}/test/slides/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        subject,
                        topic,
                        theme: 'adaptive', // Force adaptive theme
                        grade,
                        metadata: {
                            grade: grade,
                            useAdaptiveTheme: true
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.data.slides && data.data.slides.length > 0) {
                    log('Slides generated successfully!', 'success');
                    log(`Theme is adaptive for grade ${grade}`);
                    log(`Generated ${data.data.totalSlides} slides`);

                    // Deep debugging
                    console.log('========== DEEP DEBUG START ==========');
                    console.log('Raw HTML:', data.data.slides[0].html);
                    console.log('HTML Type:', typeof data.data.slides[0].html);
                    console.log('Is Escaped?', data.data.slides[0].html.includes('&lt;'));

                    // Create a temporary div to check HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.data.slides[0].html.substring(0, 500);
                    console.log('Parsed HTML (first 100):', tempDiv.textContent.substring(0, 100));
                    console.log('========== DEEP DEBUG END ==========');

                    // Debug: ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† HTML ØµØ­ÙŠØ­
                    const htmlContent = data.data.slides[0].html;
                    console.log('HTML received (first 500 chars):', htmlContent.substring(0, 500));

                    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† HTML ØºÙŠØ± escaped
                    if (htmlContent.includes('&lt;')) {
                        console.error('WARNING: HTML is escaped! Attempting to unescape...');
                        // ÙÙƒ Ø§Ù„Ù€ escaping Ø¥Ø°Ø§ Ù„Ø²Ù…
                        const div = document.createElement('div');
                        div.innerHTML = htmlContent;
                        document.getElementById('slideFrame').outerHTML =
                            '<div id="slideContainer" style="width:100%;height:100%">' +
                            (div.textContent || htmlContent) + '</div>';
                    } else {
                        console.log('HTML is not escaped, displaying directly');
                        // Display the first slide
                        document.getElementById('slideFrame').outerHTML =
                            '<div id="slideContainer" style="width:100%;height:100%">' +
                            htmlContent + '</div>';
                    }

                    showStatus('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ Ø¨Ù†Ø¬Ø§Ø­!', 'success');

                    // Check console for adaptive theme logs
                    log('Check backend console for adaptive theme logs');
                } else {
                    throw new Error('No slides generated or invalid response structure');
                }

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                showStatus(`Ø®Ø·Ø£: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        // Log initial state
        log('Test page loaded', 'success');
        log('Ready to generate adaptive slides');
    </script>
</body>
</html>