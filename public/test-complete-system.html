<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµØ­Ø­Ø©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #764ba2;
            margin-bottom: 10px;
        }
        
        .status-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .status-item {
            background: #f3f4f6;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-connected {
            background: #10b981;
            color: white;
        }
        
        .status-disconnected {
            background: #ef4444;
            color: white;
        }
        
        .test-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-success {
            background: #10b981;
        }
        
        .btn-warning {
            background: #f59e0b;
        }
        
        .btn-danger {
            background: #ef4444;
        }
        
        .input-field {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .result-box {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-viewer {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            padding: 3px 0;
        }
        
        .log-error { color: #ef4444; }
        .log-success { color: #10b981; }
        .log-warning { color: #f59e0b; }
        .log-info { color: #3b82f6; }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .slide-preview {
            background: white;
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù„Ù„Ù†Ø¸Ø§Ù… - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµØ­Ø­Ø©</h1>
            <div class="status-bar">
                <span class="status-item" id="connectionStatus">ØºÙŠØ± Ù…ØªØµÙ„</span>
                <span class="status-item" id="authStatus">ØºÙŠØ± Ù…Ø³Ø¬Ù„</span>
                <span class="status-item" id="lessonStatus">Ø¨Ø¯ÙˆÙ† Ø¯Ø±Ø³</span>
                <span class="status-item" id="time"></span>
            </div>
        </div>

        <!-- Test Sections -->
        <div class="test-grid">
            
            <!-- Connection & Auth -->
            <div class="test-section">
                <h2>ğŸ”Œ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø©</h2>
                
                <input type="text" class="input-field" id="serverUrl" 
                       value="http://localhost:3000" placeholder="Server URL">
                
                <button class="btn" onclick="testConnection()" id="connectBtn">
                    Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…
                </button>
                
                <button class="btn btn-success" onclick="testAuth()" id="authBtn" disabled>
                    ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØªØ¬Ø±ÙŠØ¨ÙŠ
                </button>
                
                <button class="btn btn-danger" onclick="disconnect()">
                    Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
                </button>
                
                <div class="result-box" id="connectionResult">
                    ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...
                </div>
            </div>

            <!-- Lessons -->
            <div class="test-section">
                <h2>ğŸ“š Ø§Ù„Ø¯Ø±ÙˆØ³</h2>
                
                <select class="input-field" id="lessonSelect">
                    <option value="">Ø§Ø®ØªØ± Ø¯Ø±Ø³...</option>
                </select>
                
                <button class="btn btn-warning" onclick="loadLessons()" id="loadBtn" disabled>
                    ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³
                </button>
                
                <button class="btn" onclick="joinLesson()" id="joinBtn" disabled>
                    Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¯Ø±Ø³
                </button>
                
                <div class="result-box" id="lessonResult">
                    ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³...
                </div>
            </div>

            <!-- Slides & Teaching -->
            <div class="test-section">
                <h2>ğŸ¨ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ³</h2>
                
                <button class="btn" onclick="testSlide()" id="slideBtn" disabled>
                    ØªÙˆÙ„ÙŠØ¯ Ø´Ø±ÙŠØ­Ø©
                </button>
                
                <button class="btn btn-success" onclick="testTeaching()" id="teachBtn" disabled>
                    Ø³ÙƒØ±ÙŠØ¨Øª ØªØ¹Ù„ÙŠÙ…ÙŠ
                </button>
                
                <button class="btn btn-warning" onclick="testVoice()" id="voiceBtn" disabled>
                    ØªÙˆÙ„ÙŠØ¯ ØµÙˆØª
                </button>
                
                <div class="result-box" id="slideResult">
                    ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ø¯Ø±Ø³...
                </div>
            </div>

            <!-- RAG & Chat -->
            <div class="test-section">
                <h2>ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h2>
                
                <input type="text" class="input-field" id="question" 
                       placeholder="Ø§Ø³Ø£Ù„ Ø³Ø¤Ø§Ù„..." value="Ù…Ø§ Ù‡Ùˆ Ù‚Ø§Ù†ÙˆÙ† ÙÙŠØ«Ø§ØºÙˆØ±Ø³ØŸ">
                
                <button class="btn" onclick="askQuestion()" id="askBtn" disabled>
                    Ø§Ø³Ø£Ù„
                </button>
                
                <button class="btn btn-success" onclick="getSummary()" id="summaryBtn" disabled>
                    Ù…Ù„Ø®Øµ Ø§Ù„Ø¯Ø±Ø³
                </button>
                
                <div class="result-box" id="aiResult">
                    ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø¤Ø§Ù„...
                </div>
            </div>

        </div>

        <!-- Slide Preview -->
        <div class="test-section" style="margin-top: 20px;">
            <h2>ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ø±ÙŠØ­Ø©</h2>
            <div class="slide-preview" id="slidePreview">
                <p style="text-align: center; color: #9ca3af;">
                    Ø³ÙŠØ¸Ù‡Ø± Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø´Ø±ÙŠØ­Ø© Ù‡Ù†Ø§...
                </p>
            </div>
        </div>

        <!-- Logs -->
        <div class="test-section">
            <h2>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h2>
            <button class="btn btn-danger" onclick="clearLogs()">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
            <div class="log-viewer" id="logs"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Global variables
        let socket = null;
        let authToken = null;
        let currentLessonId = null;
        let isConnected = false;
        let isAuthenticated = false;

        // Update time
        setInterval(() => {
            document.getElementById('time').textContent = 
                new Date().toLocaleTimeString('ar-EG');
        }, 1000);

        // Logging
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const time = new Date().toLocaleTimeString('ar-EG');
            entry.textContent = `[${time}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„', 'info');
        }

        function updateStatus(element, text, isSuccess = false) {
            const el = document.getElementById(element);
            el.textContent = text;
            el.className = `status-item ${isSuccess ? 'status-connected' : ''}`;
        }

        function showResult(element, content) {
            document.getElementById(element).innerHTML = content;
        }

        // Connection
        async function testConnection() {
            const url = document.getElementById('serverUrl').value;
            const btn = document.getElementById('connectBtn');
            btn.disabled = true;
            
            log('ğŸ”Œ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...', 'info');
            
            try {
                // Test HTTP
                const res = await fetch(`${url}/health`);
                const data = await res.json();
                
                if (data.status === 'ok') {
                    log('âœ… Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„', 'success');
                    
                    // Connect WebSocket
                    connectWebSocket(url);
                } else {
                    throw new Error('Server not ready');
                }
            } catch (error) {
                log(`âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}`, 'error');
                btn.disabled = false;
            }
        }

        function connectWebSocket(url) {
            if (socket) {
                socket.disconnect();
            }
            
            socket = io(url, {
                transports: ['websocket', 'polling']
            });
            
            socket.on('connect', () => {
                isConnected = true;
                log('âœ… WebSocket Ù…ØªØµÙ„', 'success');
                updateStatus('connectionStatus', 'Ù…ØªØµÙ„', true);
                
                document.getElementById('authBtn').disabled = false;
                document.getElementById('connectBtn').disabled = false;
            });
            
            socket.on('disconnect', () => {
                isConnected = false;
                log('âŒ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
                updateStatus('connectionStatus', 'ØºÙŠØ± Ù…ØªØµÙ„');
            });
            
            socket.on('welcome', (data) => {
                log(`ğŸ‘‹ ${data.message}`, 'success');
                showResult('connectionResult', `Socket ID: ${data.socketId}`);
            });
            
            socket.on('authenticated', (data) => {
                isAuthenticated = true;
                authToken = data.token || 'test-token';
                
                log(`âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ${data.userName}`, 'success');
                updateStatus('authStatus', data.email, true);
                
                // Enable controls
                document.getElementById('loadBtn').disabled = false;
                document.getElementById('askBtn').disabled = false;
            });
            
            socket.on('joined_lesson', (data) => {
                currentLessonId = data.lessonId;
                log(`âœ… Ø§Ù†Ø¶Ù…Ù…Øª Ù„Ù„Ø¯Ø±Ø³: ${data.lessonTitle}`, 'success');
                updateStatus('lessonStatus', data.lessonTitle, true);
                
                // Enable controls
                document.getElementById('slideBtn').disabled = false;
                document.getElementById('teachBtn').disabled = false;
                document.getElementById('voiceBtn').disabled = false;
                document.getElementById('summaryBtn').disabled = false;
                
                showResult('lessonResult', 
                    `Ø§Ù„Ø¯Ø±Ø³: ${data.lessonTitle}<br>Session: ${data.sessionId}`
                );
            });
            
            socket.on('slide_ready', (data) => {
                log('âœ… Ø§Ù„Ø´Ø±ÙŠØ­Ø© Ø¬Ø§Ù‡Ø²Ø©', 'success');
                document.getElementById('slidePreview').innerHTML = data.html;
                
                if (data.audioUrl) {
                    showResult('slideResult', 
                        `âœ… Ø§Ù„Ø´Ø±ÙŠØ­Ø© Ø¬Ø§Ù‡Ø²Ø©<br>ğŸ”Š <a href="${data.audioUrl}" target="_blank">Ø§Ù„ØµÙˆØª</a>`
                    );
                }
            });
            
            socket.on('chat_response', (data) => {
                log('ğŸ’¬ Ø±Ø¯ Ø§Ù„Ø´Ø§Øª', 'success');
                showResult('aiResult', data.response);
            });
            
            socket.on('error', (error) => {
                log(`âŒ Ø®Ø·Ø£: ${error.message}`, 'error');
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            isConnected = false;
            isAuthenticated = false;
            currentLessonId = null;
            
            updateStatus('connectionStatus', 'ØºÙŠØ± Ù…ØªØµÙ„');
            updateStatus('authStatus', 'ØºÙŠØ± Ù…Ø³Ø¬Ù„');
            updateStatus('lessonStatus', 'Ø¨Ø¯ÙˆÙ† Ø¯Ø±Ø³');
            
            log('ğŸ”Œ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', 'warning');
        }

        // Authentication
        function testAuth() {
            if (!socket) {
                log('âš ï¸ ØºÙŠØ± Ù…ØªØµÙ„', 'warning');
                return;
            }
            
            log('ğŸ” Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...', 'info');
            socket.emit('authenticate', { token: 'test-token' });
        }

        // Lessons
        async function loadLessons() {
            log('ğŸ“š Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³...', 'info');
            
            try {
                // Try the test endpoint
                const res = await fetch('http://localhost:3000/api/v1/lessons/test');
                const data = await res.json();
                
                if (data.success && data.data) {
                    const lessons = Array.isArray(data.data) ? data.data : data.data.lessons || [];
                    
                    const select = document.getElementById('lessonSelect');
                    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¯Ø±Ø³...</option>';
                    
                    lessons.forEach(lesson => {
                        const option = document.createElement('option');
                        option.value = lesson.id;
                        option.textContent = lesson.titleAr || lesson.title;
                        select.appendChild(option);
                    });
                    
                    log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${lessons.length} Ø¯Ø±Ø³`, 'success');
                    showResult('lessonResult', `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${lessons.length} Ø¯Ø±Ø³`);
                    
                    document.getElementById('joinBtn').disabled = false;
                }
            } catch (error) {
                log(`âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${error.message}`, 'error');
            }
        }

        function joinLesson() {
            const lessonId = document.getElementById('lessonSelect').value;
            
            if (!lessonId) {
                log('âš ï¸ Ø§Ø®ØªØ± Ø¯Ø±Ø³ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            log(`ğŸ“š Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¯Ø±Ø³: ${lessonId}`, 'info');
            socket.emit('join_lesson', { lessonId });
        }

        // Slides & Teaching
        function testSlide() {
            if (!currentLessonId) {
                log('âš ï¸ Ø§Ù†Ø¶Ù… Ù„Ø¯Ø±Ø³ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            log('ğŸ¨ ØªÙˆÙ„ÙŠØ¯ Ø´Ø±ÙŠØ­Ø©...', 'info');
            
            socket.emit('request_slide', {
                type: 'content',
                title: 'Ø´Ø±ÙŠØ­Ø© Ø§Ø®ØªØ¨Ø§Ø±',
                content: 'Ù‡Ø°Ø§ Ù…Ø­ØªÙˆÙ‰ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±',
                theme: 'default',
                generateTeaching: true,
                lessonId: currentLessonId
            });
        }

        function testTeaching() {
            if (!currentLessonId) {
                log('âš ï¸ Ø§Ù†Ø¶Ù… Ù„Ø¯Ø±Ø³ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            log('ğŸ‘¨â€ğŸ« ØªÙˆÙ„ÙŠØ¯ Ø³ÙƒØ±ÙŠØ¨Øª ØªØ¹Ù„ÙŠÙ…ÙŠ...', 'info');
            
            socket.emit('generate_teaching_script', {
                lessonId: currentLessonId,
                slideContent: {
                    title: 'Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª',
                    content: 'Ø­Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ù…Ù† Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰'
                },
                studentGrade: 9
            });
            
            socket.once('teaching_script_ready', (data) => {
                log('âœ… Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø¬Ø§Ù‡Ø²', 'success');
                showResult('slideResult', data.script.substring(0, 200) + '...');
            });
        }

        function testVoice() {
            log('ğŸ”Š ØªÙˆÙ„ÙŠØ¯ ØµÙˆØª...', 'info');
            
            socket.emit('generate_slide_voice', {
                slideContent: {
                    type: 'content',
                    title: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØª',
                    content: 'Ù‡Ø°Ø§ Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù†Ø¸Ø§Ù… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØª'
                }
            });
            
            socket.once('voice_ready', (data) => {
                log('âœ… Ø§Ù„ØµÙˆØª Ø¬Ø§Ù‡Ø²', 'success');
                showResult('slideResult', `ğŸ”Š <a href="${data.audioUrl}" target="_blank">Ø§Ø³ØªÙ…Ø¹</a>`);
            });
        }

        // AI & RAG
        function askQuestion() {
            const question = document.getElementById('question').value;
            
            if (!question) {
                log('âš ï¸ Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„', 'warning');
                return;
            }
            
            log(`ğŸ¤– Ø§Ù„Ø³Ø¤Ø§Ù„: ${question}`, 'info');
            
            socket.emit('chat_message', {
                message: question,
                lessonId: currentLessonId
            });
        }

        function getSummary() {
            if (!currentLessonId) {
                log('âš ï¸ Ø§Ù†Ø¶Ù… Ù„Ø¯Ø±Ø³ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            log('ğŸ“„ Ø·Ù„Ø¨ Ù…Ù„Ø®Øµ...', 'info');
            
            socket.emit('get_lesson_summary', { lessonId: currentLessonId });
            
            socket.once('lesson_summary', (data) => {
                log('âœ… Ø§Ù„Ù…Ù„Ø®Øµ Ø¬Ø§Ù‡Ø²', 'success');
                showResult('aiResult', data.summary);
            });
        }

        // Initialize
        window.onload = () => {
            log('ğŸš€ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²', 'success');
            log('ğŸ’¡ Ø§Ø¶ØºØ· "Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…" Ù„Ù„Ø¨Ø¯Ø¡', 'info');
        };
    </script>
</body>
</html>